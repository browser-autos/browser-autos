# Browser.autos CDP API æœåŠ¡æŠ€æœ¯æ–‡æ¡£

## é¡¹ç›®æ¦‚è¿°

Browser.autos æ˜¯ä¸€ä¸ªåŸºäº Chrome DevTools Protocol (CDP) çš„æµè§ˆå™¨è‡ªåŠ¨åŒ– API æœåŠ¡ï¼Œæ—¨åœ¨æä¾›ä¸ [browserless](https://github.com/browserless/browserless) ç±»ä¼¼çš„åŠŸèƒ½ï¼Œæ”¯æŒé€šè¿‡ WebSocket å’Œ REST API è¿›è¡Œæ— å¤´æµè§ˆå™¨æ§åˆ¶ã€‚

**é¡¹ç›®ç‰¹ç‚¹ï¼š**
- ğŸš€ æ”¯æŒ Puppeteer å’Œ Playwright ç­‰ä¸»æµè‡ªåŠ¨åŒ–åº“
- ğŸ”Œ æä¾› WebSocket å’Œ REST API åŒé‡æ¥å£
- ğŸ³ åŸºäº Docker å®¹å™¨åŒ–éƒ¨ç½²
- âš¡ å†…ç½®å¹¶å‘æ§åˆ¶å’Œè¯·æ±‚é˜Ÿåˆ—ç®¡ç†
- ğŸ“Š å®Œæ•´çš„å¯è§‚æµ‹æ€§å’Œç›‘æ§æ”¯æŒ
- ğŸ”’ ä¼ä¸šçº§å®‰å…¨éš”ç¦»æœºåˆ¶

---

## æŠ€æœ¯æ ˆé€‰å‹

### åç«¯æœåŠ¡

åŸºäºå¯¹ browserless çš„è°ƒç ”ï¼Œæ¨èä½¿ç”¨ä»¥ä¸‹æŠ€æœ¯æ ˆï¼š

#### **æ ¸å¿ƒè¯­è¨€ï¼šTypeScript + Node.js**

**é€‰æ‹©ç†ç”±ï¼š**
1. **ç”Ÿæ€å…¼å®¹æ€§**ï¼šPuppeteer å’Œ Playwright éƒ½æ˜¯ Node.js åŸç”Ÿåº“ï¼Œæ— ç¼é›†æˆ
2. **CDP åè®®æ”¯æŒ**ï¼šNode.js å¯¹ WebSocket å’Œ CDP åè®®æ”¯æŒæˆç†Ÿ
3. **ç±»å‹å®‰å…¨**ï¼šTypeScript æä¾›å¼ºç±»å‹æ£€æŸ¥ï¼Œæé«˜ä»£ç è´¨é‡
4. **ç¤¾åŒºæ”¯æŒ**ï¼šbrowserless å®˜æ–¹é¡¹ç›®ä½¿ç”¨ TypeScript å¼€å‘ï¼ˆ92.2% TypeScriptï¼‰
5. **å¼€å‘æ•ˆç‡**ï¼šå‰åç«¯ç»Ÿä¸€è¯­è¨€æ ˆï¼Œé™ä½å­¦ä¹ æˆæœ¬

#### **æ¡†æ¶å’Œåº“**

| ç»„ä»¶ | æŠ€æœ¯é€‰å‹ | ç”¨é€” |
|------|---------|------|
| **Web æ¡†æ¶** | Fastify æˆ– Express | HTTP æœåŠ¡å™¨å’Œè·¯ç”± |
| **WebSocket** | ws åº“ | CDP åè®® WebSocket ä»£ç† |
| **æµè§ˆå™¨æ§åˆ¶** | Puppeteer Core | æ— å¤´æµè§ˆå™¨æ§åˆ¶ |
| **é˜Ÿåˆ—ç®¡ç†** | Bull / BullMQ | è¯·æ±‚é˜Ÿåˆ—å’Œå¹¶å‘æ§åˆ¶ |
| **æ¶ˆæ¯é˜Ÿåˆ—** | Redis | ä»»åŠ¡é˜Ÿåˆ—åç«¯å­˜å‚¨ |
| **æ—¥å¿—** | Pino | é«˜æ€§èƒ½ç»“æ„åŒ–æ—¥å¿— |
| **ç›‘æ§** | Prometheus Client | æŒ‡æ ‡é‡‡é›†å’Œç›‘æ§ |
| **å®¹å™¨** | Docker | æœåŠ¡å®¹å™¨åŒ– |

---

## æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       å®¢æˆ·ç«¯å±‚                           â”‚
â”‚  Puppeteer / Playwright / REST API Clients              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ WebSocket / HTTP
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API Gateway å±‚                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ WebSocket    â”‚          â”‚  REST API   â”‚             â”‚
â”‚  â”‚ Proxy Server â”‚          â”‚  Endpoints  â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ä¸šåŠ¡é€»è¾‘å±‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Session      â”‚  â”‚ Queue        â”‚  â”‚ Task         â”‚ â”‚
â”‚  â”‚ Manager      â”‚  â”‚ Manager      â”‚  â”‚ Executor     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Chrome å®ä¾‹æ±                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚Chromeâ”‚  â”‚Chromeâ”‚  â”‚Chromeâ”‚  â”‚Chromeâ”‚  â”‚Chromeâ”‚    â”‚
â”‚  â”‚  #1  â”‚  â”‚  #2  â”‚  â”‚  #3  â”‚  â”‚  #4  â”‚  â”‚  #5  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒæ¨¡å—è¯´æ˜

#### 1. **API Gateway å±‚**

**WebSocket Proxy Server**
- ç›‘å¬å®¢æˆ·ç«¯ WebSocket è¿æ¥è¯·æ±‚
- éªŒè¯ Token å’Œæƒé™
- åˆ›å»ºæ–°çš„ Chrome å®ä¾‹å¹¶å»ºç«‹ CDP è¿æ¥
- ä»£ç†å®¢æˆ·ç«¯æ¶ˆæ¯åˆ° Chrome å®ä¾‹
- æ”¯æŒå¤šç§Ÿæˆ·éš”ç¦»

**REST API Endpoints**
```typescript
// æ ¸å¿ƒ REST API ç«¯ç‚¹
POST   /screenshot    // ç½‘é¡µæˆªå›¾
POST   /pdf           // ç”Ÿæˆ PDF
POST   /content       // è·å–é¡µé¢å†…å®¹
POST   /scrape        // æ•°æ®æŠ“å–
GET    /health        // å¥åº·æ£€æŸ¥
GET    /metrics       // Prometheus æŒ‡æ ‡
GET    /sessions      // æ´»è·ƒä¼šè¯åˆ—è¡¨
DELETE /sessions/:id  // å…³é—­æŒ‡å®šä¼šè¯
```

#### 2. **Session Managerï¼ˆä¼šè¯ç®¡ç†å™¨ï¼‰**

```typescript
interface SessionConfig {
  id: string;
  userId: string;
  maxDuration: number;      // æœ€å¤§å­˜æ´»æ—¶é—´
  timeout: number;          // ç©ºé—²è¶…æ—¶
  browserArgs: string[];    // Chrome å¯åŠ¨å‚æ•°
  viewport: { width: number; height: number };
}

class SessionManager {
  async createSession(config: SessionConfig): Promise<Session>
  async getSession(sessionId: string): Promise<Session | null>
  async closeSession(sessionId: string): Promise<void>
  async cleanupIdleSessions(): Promise<void>
  getActiveSessions(): Session[]
}
```

#### 3. **Queue Managerï¼ˆé˜Ÿåˆ—ç®¡ç†å™¨ï¼‰**

```typescript
interface QueueConfig {
  maxConcurrent: number;    // æœ€å¤§å¹¶å‘æ•°
  timeout: number;          // ä»»åŠ¡è¶…æ—¶æ—¶é—´
  retries: number;          // é‡è¯•æ¬¡æ•°
  priority: 'high' | 'normal' | 'low';
}

class QueueManager {
  async addTask<T>(task: Task<T>, config: QueueConfig): Promise<T>
  async getQueueStatus(): Promise<QueueStatus>
  async pauseQueue(): Promise<void>
  async resumeQueue(): Promise<void>
}
```

#### 4. **Browser Poolï¼ˆæµè§ˆå™¨æ± ï¼‰**

```typescript
interface BrowserPoolConfig {
  minInstances: number;     // æœ€å°å®ä¾‹æ•°
  maxInstances: number;     // æœ€å¤§å®ä¾‹æ•°
  maxAge: number;           // å®ä¾‹æœ€å¤§å­˜æ´»æ—¶é—´
  launchOptions: PuppeteerLaunchOptions;
}

class BrowserPool {
  async acquire(): Promise<Browser>
  async release(browser: Browser): Promise<void>
  async drain(): Promise<void>
  getPoolStats(): PoolStats
}
```

---

## é¡¹ç›®ç›®å½•ç»“æ„

```
browser.autos/
â”œâ”€â”€ frontend/                 # Next.js å‰ç«¯ï¼ˆå·²å®Œæˆï¼‰
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â””â”€â”€ contexts/
â”‚   â””â”€â”€ package.json
â”‚
â”œâ”€â”€ backend/                  # åç«¯ API æœåŠ¡ï¼ˆå¾…å¼€å‘ï¼‰
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ api/             # API è·¯ç”±å’Œæ§åˆ¶å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ websocket/   # WebSocket å¤„ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ rest/        # REST API ç«¯ç‚¹
â”‚   â”‚   â”‚   â””â”€â”€ middleware/  # ä¸­é—´ä»¶ï¼ˆè®¤è¯ã€é™æµç­‰ï¼‰
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ core/            # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â”‚   â”œâ”€â”€ session/     # ä¼šè¯ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ queue/       # é˜Ÿåˆ—ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ browser/     # æµè§ˆå™¨æ± ç®¡ç†
â”‚   â”‚   â”‚   â””â”€â”€ executor/    # ä»»åŠ¡æ‰§è¡Œå™¨
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ services/        # ä¸šåŠ¡æœåŠ¡
â”‚   â”‚   â”‚   â”œâ”€â”€ screenshot.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ pdf.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ scraping.service.ts
â”‚   â”‚   â”‚   â””â”€â”€ cdp.service.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ utils/           # å·¥å…·å‡½æ•°
â”‚   â”‚   â”‚   â”œâ”€â”€ logger.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ metrics.ts
â”‚   â”‚   â”‚   â””â”€â”€ validation.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ types/           # TypeScript ç±»å‹å®šä¹‰
â”‚   â”‚   â”‚   â”œâ”€â”€ api.types.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ session.types.ts
â”‚   â”‚   â”‚   â””â”€â”€ queue.types.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ config/          # é…ç½®ç®¡ç†
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ index.ts         # å…¥å£æ–‡ä»¶
â”‚   â”‚
â”‚   â”œâ”€â”€ tests/               # æµ‹è¯•æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ unit/
â”‚   â”‚   â”œâ”€â”€ integration/
â”‚   â”‚   â””â”€â”€ e2e/
â”‚   â”‚
â”‚   â”œâ”€â”€ Dockerfile           # Docker é…ç½®
â”‚   â”œâ”€â”€ tsconfig.json        # TypeScript é…ç½®
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ .env.example
â”‚
â”œâ”€â”€ docker-compose.yml       # Docker Compose é…ç½®
â”œâ”€â”€ .github/                 # GitHub Actions CI/CD
â”‚   â””â”€â”€ workflows/
â”‚       â””â”€â”€ deploy.yml
â”‚
â””â”€â”€ docs/                    # æ–‡æ¡£
    â”œâ”€â”€ API.md               # API æ–‡æ¡£
    â”œâ”€â”€ DEPLOYMENT.md        # éƒ¨ç½²æ–‡æ¡£
    â””â”€â”€ DEVELOPMENT.md       # å¼€å‘æ–‡æ¡£
```

---

## API è®¾è®¡

### WebSocket API

#### è¿æ¥ç«¯ç‚¹

```
ws://localhost:3000?token=YOUR_TOKEN
ws://localhost:3000/chrome?token=YOUR_TOKEN
ws://localhost:3000/firefox?token=YOUR_TOKEN
```

#### è¿æ¥æµç¨‹

```typescript
// å®¢æˆ·ç«¯ç¤ºä¾‹ï¼ˆPuppeteerï¼‰
import puppeteer from 'puppeteer-core';

const browser = await puppeteer.connect({
  browserWSEndpoint: 'ws://localhost:3000?token=YOUR_TOKEN'
});

const page = await browser.newPage();
await page.goto('https://example.com');
const screenshot = await page.screenshot();
await browser.close();
```

### REST API

#### 1. æˆªå›¾ API

```http
POST /screenshot
Content-Type: application/json
Authorization: Bearer YOUR_TOKEN

{
  "url": "https://example.com",
  "fullPage": true,
  "viewport": {
    "width": 1920,
    "height": 1080
  },
  "format": "png",
  "quality": 90
}

Response: image/png (binary)
```

#### 2. PDF ç”Ÿæˆ API

```http
POST /pdf
Content-Type: application/json
Authorization: Bearer YOUR_TOKEN

{
  "url": "https://example.com",
  "format": "A4",
  "printBackground": true,
  "margin": {
    "top": "1cm",
    "right": "1cm",
    "bottom": "1cm",
    "left": "1cm"
  }
}

Response: application/pdf (binary)
```

#### 3. å†…å®¹æŠ“å– API

```http
POST /scrape
Content-Type: application/json
Authorization: Bearer YOUR_TOKEN

{
  "url": "https://example.com",
  "elements": [
    {
      "selector": "h1",
      "property": "textContent"
    },
    {
      "selector": ".price",
      "property": "textContent"
    }
  ],
  "waitUntil": "networkidle0"
}

Response:
{
  "data": [
    { "selector": "h1", "value": "Example Title" },
    { "selector": ".price", "value": "$99.99" }
  ],
  "timestamp": "2025-10-11T10:30:00Z"
}
```

#### 4. å¥åº·æ£€æŸ¥ API

```http
GET /health

Response:
{
  "status": "healthy",
  "uptime": 3600,
  "activeSessions": 5,
  "queueLength": 2,
  "browserPool": {
    "active": 5,
    "idle": 3,
    "max": 10
  }
}
```

---

## é…ç½®ç®¡ç†

### ç¯å¢ƒå˜é‡é…ç½®

```bash
# .env.example

# æœåŠ¡é…ç½®
PORT=3000
NODE_ENV=production
LOG_LEVEL=info

# è®¤è¯
JWT_SECRET=your-secret-key
TOKEN_EXPIRY=30d

# Chrome é…ç½®
MAX_CONCURRENT_SESSIONS=10
SESSION_TIMEOUT=300000        # 5åˆ†é’Ÿ
MAX_SESSION_DURATION=3600000  # 1å°æ—¶
CHROME_EXECUTABLE_PATH=/usr/bin/chromium

# æµè§ˆå™¨æ± é…ç½®
BROWSER_POOL_MIN=2
BROWSER_POOL_MAX=10
BROWSER_MAX_AGE=3600000

# é˜Ÿåˆ—é…ç½®
REDIS_URL=redis://localhost:6379
QUEUE_MAX_CONCURRENT=5
QUEUE_TIMEOUT=120000
QUEUE_RETRIES=3

# ç›‘æ§é…ç½®
ENABLE_METRICS=true
METRICS_PORT=9090

# èµ„æºé™åˆ¶
MAX_MEMORY_PER_BROWSER=512     # MB
MAX_CPU_PER_BROWSER=50         # %
```

---

## Docker éƒ¨ç½²

### Dockerfile

```dockerfile
# åŸºç¡€é•œåƒä½¿ç”¨å®˜æ–¹ Node.js é•œåƒ
FROM node:20-bookworm-slim

# å®‰è£… Chrome ä¾èµ–
RUN apt-get update && apt-get install -y \
    chromium \
    chromium-driver \
    fonts-liberation \
    fonts-noto-color-emoji \
    libappindicator3-1 \
    libasound2 \
    libatk-bridge2.0-0 \
    libatk1.0-0 \
    libcups2 \
    libdbus-1-3 \
    libdrm2 \
    libgbm1 \
    libgtk-3-0 \
    libnspr4 \
    libnss3 \
    libx11-xcb1 \
    libxcomposite1 \
    libxdamage1 \
    libxrandr2 \
    xdg-utils \
    && rm -rf /var/lib/apt/lists/*

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY backend/package*.json ./

# å®‰è£…ä¾èµ–
RUN npm ci --only=production

# å¤åˆ¶æºä»£ç 
COPY backend/src ./src
COPY backend/tsconfig.json ./

# æ„å»º TypeScript
RUN npm run build

# åˆ›å»ºé root ç”¨æˆ·
RUN useradd -m -u 1001 browserless && \
    chown -R browserless:browserless /app

USER browserless

# æš´éœ²ç«¯å£
EXPOSE 3000 9090

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD node -e "require('http').get('http://localhost:3000/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"

# å¯åŠ¨æœåŠ¡
CMD ["node", "dist/index.js"]
```

### docker-compose.yml

```yaml
version: '3.8'

services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  browser-api:
    build:
      context: .
      dockerfile: backend/Dockerfile
    ports:
      - "3000:3000"
      - "9090:9090"
    environment:
      - NODE_ENV=production
      - REDIS_URL=redis://redis:6379
      - MAX_CONCURRENT_SESSIONS=10
      - LOG_LEVEL=info
    depends_on:
      redis:
        condition: service_healthy
    volumes:
      - /dev/shm:/dev/shm
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2'
        reservations:
          memory: 2G
          cpus: '1'
    restart: unless-stopped

  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9091:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'

volumes:
  redis-data:
  prometheus-data:
```

---

## ç›‘æ§å’Œå¯è§‚æµ‹æ€§

### Prometheus æŒ‡æ ‡

```typescript
// è‡ªå®šä¹‰æŒ‡æ ‡
export const metrics = {
  httpRequestsTotal: new Counter({
    name: 'http_requests_total',
    help: 'Total HTTP requests',
    labelNames: ['method', 'path', 'status']
  }),

  activeSessionsGauge: new Gauge({
    name: 'active_sessions',
    help: 'Number of active browser sessions'
  }),

  queueLengthGauge: new Gauge({
    name: 'queue_length',
    help: 'Number of tasks in queue'
  }),

  taskDurationHistogram: new Histogram({
    name: 'task_duration_seconds',
    help: 'Task execution duration',
    labelNames: ['task_type'],
    buckets: [0.1, 0.5, 1, 2, 5, 10, 30]
  }),

  browserPoolGauge: new Gauge({
    name: 'browser_pool_size',
    help: 'Browser pool metrics',
    labelNames: ['state'] // active, idle
  })
};
```

### æ—¥å¿—ç»“æ„

```typescript
// ä½¿ç”¨ Pino ç»“æ„åŒ–æ—¥å¿—
import pino from 'pino';

const logger = pino({
  level: process.env.LOG_LEVEL || 'info',
  transport: {
    target: 'pino-pretty',
    options: {
      colorize: true,
      translateTime: 'SYS:standard'
    }
  }
});

// æ—¥å¿—ç¤ºä¾‹
logger.info({
  sessionId: 'xxx',
  userId: 'yyy',
  duration: 1234
}, 'Session closed');
```

---

## å®‰å…¨æ€§è®¾è®¡

### 1. Token è®¤è¯

```typescript
// JWT Token éªŒè¯
import jwt from 'jsonwebtoken';

interface TokenPayload {
  userId: string;
  tier: 'free' | 'pro' | 'enterprise';
  rateLimit: number;
}

function verifyToken(token: string): TokenPayload {
  return jwt.verify(token, process.env.JWT_SECRET!) as TokenPayload;
}
```

### 2. é€Ÿç‡é™åˆ¶

```typescript
// åŸºäº Redis çš„é€Ÿç‡é™åˆ¶
import rateLimit from 'express-rate-limit';
import RedisStore from 'rate-limit-redis';

const limiter = rateLimit({
  store: new RedisStore({
    client: redisClient
  }),
  windowMs: 15 * 60 * 1000,  // 15åˆ†é’Ÿ
  max: 100,                   // æœ€å¤š 100 ä¸ªè¯·æ±‚
  message: 'Too many requests'
});
```

### 3. å®¹å™¨éš”ç¦»

- æ¯ä¸ªæµè§ˆå™¨å®ä¾‹è¿è¡Œåœ¨ç‹¬ç«‹çš„æ²™ç®±ç¯å¢ƒ
- ä½¿ç”¨ Docker seccomp å’Œ AppArmor é…ç½®
- é™åˆ¶ç³»ç»Ÿè°ƒç”¨å’Œæ–‡ä»¶è®¿é—®æƒé™

### 4. èµ„æºé™åˆ¶

```typescript
// Chrome å¯åŠ¨å‚æ•°
const browserArgs = [
  '--no-sandbox',
  '--disable-setuid-sandbox',
  '--disable-dev-shm-usage',
  '--disable-gpu',
  '--disable-software-rasterizer',
  `--max-old-space-size=${MAX_MEMORY}`,
  '--disable-background-networking',
  '--disable-background-timer-throttling'
];
```

---

## å¼€å‘è·¯çº¿å›¾

### Phase 1: æ ¸å¿ƒåŠŸèƒ½å¼€å‘ï¼ˆ2-3å‘¨ï¼‰

- [x] é¡¹ç›®åˆå§‹åŒ–å’ŒåŸºç¡€æ¶æ„æ­å»º
  - [x] åˆ›å»ºåç«¯ç›®å½•ç»“æ„
  - [x] é…ç½® TypeScript å’Œæ„å»ºå·¥å…·
  - [x] å®ç° Logger å·¥å…·ç±»
  - [x] å®ç°é…ç½®ç®¡ç†æ¨¡å—
  - [x] å®šä¹‰å®Œæ•´çš„ TypeScript ç±»å‹ç³»ç»Ÿ
  - [x] åˆ›å»ºåŸºç¡€ Fastify æœåŠ¡å™¨
- [ ] WebSocket ä»£ç†æœåŠ¡å™¨å®ç°
- [ ] ä¼šè¯ç®¡ç†å™¨å¼€å‘
- [ ] æµè§ˆå™¨æ± ç®¡ç†
- [ ] REST API åŸºç¡€ç«¯ç‚¹ï¼ˆscreenshot, pdf, contentï¼‰
- [ ] Token è®¤è¯å’Œæˆæƒ

### Phase 2: é«˜çº§åŠŸèƒ½å¼€å‘ï¼ˆ2-3å‘¨ï¼‰

- [ ] é˜Ÿåˆ—ç®¡ç†å’Œå¹¶å‘æ§åˆ¶
- [ ] æ•°æ®æŠ“å–æœåŠ¡
- [ ] Webhook å›è°ƒæ”¯æŒ
- [ ] é‡è¯•æœºåˆ¶å’Œé”™è¯¯å¤„ç†
- [ ] æ—¥å¿—å’Œç›‘æ§é›†æˆ
- [ ] API æ–‡æ¡£ç”Ÿæˆï¼ˆSwagger/OpenAPIï¼‰

### Phase 3: ç”Ÿäº§ä¼˜åŒ–ï¼ˆ1-2å‘¨ï¼‰

- [ ] æ€§èƒ½ä¼˜åŒ–å’Œå‹åŠ›æµ‹è¯•
- [ ] Docker é•œåƒä¼˜åŒ–
- [ ] CI/CD æµç¨‹å»ºç«‹
- [ ] å®‰å…¨åŠ å›º
- [ ] å‰åç«¯é›†æˆæµ‹è¯•
- [ ] ç”¨æˆ·æ–‡æ¡£ç¼–å†™

### Phase 4: æ‰©å±•åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰

- [ ] å¤šæµè§ˆå™¨æ”¯æŒï¼ˆFirefox, WebKitï¼‰
- [ ] åˆ†å¸ƒå¼éƒ¨ç½²æ”¯æŒ
- [ ] Kubernetes Helm Chart
- [ ] GraphQL API æ”¯æŒ
- [ ] å®æ—¶ WebSocket æ¨é€
- [ ] æµè§ˆå™¨å½•åˆ¶å›æ”¾åŠŸèƒ½

---

## æ€§èƒ½åŸºå‡†

### ç›®æ ‡æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | è¯´æ˜ |
|------|--------|------|
| API å“åº”æ—¶é—´ï¼ˆP95ï¼‰ | < 500ms | ä¸å«æµè§ˆå™¨æ¸²æŸ“æ—¶é—´ |
| æµè§ˆå™¨å¯åŠ¨æ—¶é—´ | < 2s | å†·å¯åŠ¨åˆ°å¯ç”¨ |
| æœ€å¤§å¹¶å‘ä¼šè¯ | 50+ | å•å®ä¾‹æ”¯æŒ |
| å†…å­˜å ç”¨ | < 4GB | 10ä¸ªå¹¶å‘ä¼šè¯ |
| æˆªå›¾ç”Ÿæˆé€Ÿåº¦ | < 3s | æ ‡å‡†ç½‘é¡µ |
| PDF ç”Ÿæˆé€Ÿåº¦ | < 5s | æ ‡å‡†ç½‘é¡µ |

### è´Ÿè½½æµ‹è¯•åœºæ™¯

```bash
# ä½¿ç”¨ k6 è¿›è¡Œè´Ÿè½½æµ‹è¯•
k6 run --vus 10 --duration 30s load-test.js
```

---

## å‚è€ƒèµ„æº

### å®˜æ–¹æ–‡æ¡£

- [Browserless å®˜æ–¹ä»“åº“](https://github.com/browserless/browserless)
- [Puppeteer æ–‡æ¡£](https://pptr.dev/)
- [Chrome DevTools Protocol](https://chromedevtools.github.io/devtools-protocol/)

### æŠ€æœ¯æ–‡ç« 

- [Building a Scalable Headless Browser Service](https://www.browserless.io/blog)
- [Docker Best Practices for Node.js](https://nodejs.org/en/docs/guides/nodejs-docker-webapp/)

### ç«å“åˆ†æ

- Browserless.io (å•†ä¸šæœåŠ¡)
- Apify (çˆ¬è™«å¹³å°)
- Selenium Grid
- Playwright Server

---

## ç»´æŠ¤è€…

- **é¡¹ç›®è´Ÿè´£äºº**: [Your Name]
- **æŠ€æœ¯æ ˆ**: TypeScript, Node.js, Docker, Puppeteer
- **è®¸å¯è¯**: MIT License

---

## å®æ–½è¿›åº¦

### âœ… å·²å®Œæˆ (2025-10-11)

#### 1. é¡¹ç›®åŸºç¡€æ¶æ„
- âœ… åˆ›å»ºå®Œæ•´çš„åç«¯ç›®å½•ç»“æ„
  - `backend/src/api/` - API è·¯ç”±å±‚
  - `backend/src/core/` - æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
  - `backend/src/services/` - ä¸šåŠ¡æœåŠ¡
  - `backend/src/utils/` - å·¥å…·å‡½æ•°
  - `backend/src/types/` - TypeScript ç±»å‹å®šä¹‰
  - `backend/src/config/` - é…ç½®ç®¡ç†

#### 2. å¼€å‘ç¯å¢ƒé…ç½®
- âœ… `package.json` - ä¾èµ–ç®¡ç†å’Œè„šæœ¬é…ç½®
  - å¼€å‘ä¾èµ–ï¼šTypeScript, ESLint, Prettier, Jest
  - è¿è¡Œæ—¶ä¾èµ–ï¼šFastify, Puppeteer, Bull, Redis, Pino
- âœ… `tsconfig.json` - TypeScript ä¸¥æ ¼æ¨¡å¼é…ç½®
- âœ… `.eslintrc.json` - ä»£ç è§„èŒƒé…ç½®
- âœ… `.prettierrc` - ä»£ç æ ¼å¼åŒ–é…ç½®
- âœ… `.env` å’Œ `.env.example` - ç¯å¢ƒå˜é‡é…ç½®

#### 3. æ ¸å¿ƒå·¥å…·ç±»
- âœ… `src/utils/logger.ts` - Pino æ—¥å¿—å·¥å…·
  - æ”¯æŒå¼€å‘/ç”Ÿäº§ç¯å¢ƒä¸åŒæ ¼å¼
  - ç»“æ„åŒ–æ—¥å¿—è¾“å‡º
  - æ¨¡å—åŒ– Logger åˆ›å»º

#### 4. é…ç½®ç®¡ç†
- âœ… `src/config/index.ts` - ç»Ÿä¸€é…ç½®ç®¡ç†
  - ä½¿ç”¨ Zod è¿›è¡Œé…ç½®éªŒè¯
  - å®Œæ•´çš„ç¯å¢ƒå˜é‡è§£æ
  - Chrome å¯åŠ¨å‚æ•°é…ç½®
  - ç¯å¢ƒåˆ¤æ–­è¾…åŠ©å‡½æ•°

#### 5. TypeScript ç±»å‹ç³»ç»Ÿ
- âœ… `src/types/api.types.ts` - API è¯·æ±‚/å“åº”ç±»å‹
  - Screenshot, PDF, Content, Scrape è¯·æ±‚ç±»å‹
  - é€šç”¨ API å“åº”å’Œé”™è¯¯ç±»å‹
  - å¥åº·æ£€æŸ¥å’Œåˆ†é¡µç±»å‹
- âœ… `src/types/session.types.ts` - Session ç®¡ç†ç±»å‹
  - Session é…ç½®å’Œå®ä¾‹ç±»å‹
  - Session çŠ¶æ€æšä¸¾
  - Session äº‹ä»¶ç³»ç»Ÿ
- âœ… `src/types/queue.types.ts` - é˜Ÿåˆ—ç®¡ç†ç±»å‹
  - Task ç±»å‹å’ŒçŠ¶æ€
  - Queue é…ç½®å’Œç»Ÿè®¡
  - ä¼˜å…ˆçº§å’Œé‡è¯•æœºåˆ¶
- âœ… `src/types/browser.types.ts` - Browser Pool ç±»å‹
  - æµè§ˆå™¨å®ä¾‹å…ƒæ•°æ®
  - èµ„æºä½¿ç”¨ç»Ÿè®¡
  - æµè§ˆå™¨äº‹ä»¶ç³»ç»Ÿ

#### 6. åŸºç¡€æœåŠ¡å™¨
- âœ… `src/index.ts` - åº”ç”¨å…¥å£
  - ä¼˜é›…å…³é—­å¤„ç†
  - æœªæ•è·å¼‚å¸¸å¤„ç†
- âœ… `src/server.ts` - Fastify æœåŠ¡å™¨
  - CORS é…ç½®
  - å®‰å…¨å¤´é…ç½®
  - é€Ÿç‡é™åˆ¶
  - é”™è¯¯å¤„ç†ä¸­é—´ä»¶
  - åŸºç¡€å¥åº·æ£€æŸ¥ç«¯ç‚¹

#### 7. æ–‡æ¡£
- âœ… `backend/README.md` - åç«¯é¡¹ç›®æ–‡æ¡£
  - å¿«é€Ÿå¼€å§‹æŒ‡å—
  - é¡¹ç›®ç»“æ„è¯´æ˜
  - å¼€å‘è¿›åº¦è¿½è¸ª

#### 8. Screenshot API (MVP) â­ NEW
- âœ… `src/services/screenshot.service.ts` - Screenshot æœåŠ¡å®ç°
  - Puppeteer Core é›†æˆ
  - æ”¯æŒå…¨é¡µ/å…ƒç´ æˆªå›¾
  - å¤šç§å›¾ç‰‡æ ¼å¼ (PNG, JPEG, WebP)
  - è‡ªå®šä¹‰è§†å£å’Œç­‰å¾…ç­–ç•¥
- âœ… `src/api/rest/screenshot.route.ts` - Screenshot API è·¯ç”±
  - Zod å‚æ•°éªŒè¯
  - å®Œå–„çš„é”™è¯¯å¤„ç†
  - ç»“æ„åŒ–æ—¥å¿—è®°å½•
- âœ… **æµ‹è¯•éªŒè¯**
  - âœ… åŸºç¡€æˆªå›¾åŠŸèƒ½ï¼ˆexample.com, 7.6sï¼‰
  - âœ… JPEG æ ¼å¼å’Œè‡ªå®šä¹‰è§†å£ï¼ˆgithub.com, 4.8sï¼‰
  - âœ… URL å‚æ•°éªŒè¯
  - âœ… é”™è¯¯å¤„ç†æœºåˆ¶

#### 9. Browser Pool (æµè§ˆå™¨æ± ) â­ NEW
- âœ… `src/core/browser/BrowserPool.ts` - æµè§ˆå™¨æ± æ ¸å¿ƒå®ç°
  - æµè§ˆå™¨å®ä¾‹ç”Ÿå‘½å‘¨æœŸç®¡ç†
  - è‡ªåŠ¨åˆ›å»ºå’Œå¤ç”¨æœºåˆ¶
  - çŠ¶æ€è·Ÿè¸ªï¼ˆidle, busy, launching, closed, errorï¼‰
  - æœ€å¤§å¹´é¾„è‡ªåŠ¨æ¸…ç†
  - èµ„æºæ± ç»Ÿè®¡ä¿¡æ¯
- âœ… **é›†æˆå’Œä¼˜åŒ–**
  - âœ… Screenshot Service é›†æˆæµè§ˆå™¨æ± 
  - âœ… å¥åº·æ£€æŸ¥ç«¯ç‚¹å±•ç¤ºæ± çŠ¶æ€
  - âœ… ä¼˜é›…çš„é”™è¯¯å¤„ç†å’Œèµ„æºé‡Šæ”¾
- âœ… **æ€§èƒ½éªŒè¯**
  - âœ… å†·å¯åŠ¨ï¼š2.6ç§’ï¼ˆé¦–æ¬¡åˆ›å»ºæµè§ˆå™¨ï¼‰
  - âœ… çƒ­å¯åŠ¨ï¼š~1.2ç§’ï¼ˆå¤ç”¨æµè§ˆå™¨ï¼‰
  - âœ… **æ€§èƒ½æå‡ï¼š85%** (7.6s â†’ 1.2s)
  - âœ… æµè§ˆå™¨å¤ç”¨æˆåŠŸéªŒè¯

#### 10. PDF Generation API â­ NEW
- âœ… `src/services/pdf.service.ts` - PDF ç”ŸæˆæœåŠ¡
  - æ”¯æŒå¤šç§é¡µé¢æ ¼å¼ï¼ˆA4, A3, Letter, Legalï¼‰
  - æ¨ªå‘/çºµå‘å¸ƒå±€
  - è‡ªå®šä¹‰è¾¹è·å’Œç¼©æ”¾æ¯”ä¾‹
  - é¡µçœ‰é¡µè„šæ¨¡æ¿æ”¯æŒ
  - èƒŒæ™¯æ‰“å°é€‰é¡¹
  - æµè§ˆå™¨æ± å¤ç”¨ä¼˜åŒ–
- âœ… `src/api/rest/pdf.route.ts` - PDF API è·¯ç”±
  - Zod å‚æ•°éªŒè¯
  - å®Œå–„çš„é”™è¯¯å¤„ç†
  - ç»“æ„åŒ–æ—¥å¿—è®°å½•
- âœ… **æµ‹è¯•éªŒè¯**
  - âœ… åŸºç¡€ PDF ç”Ÿæˆï¼ˆexample.com, ~8sï¼‰
  - âœ… æ¨ªå‘ A4 + è‡ªå®šä¹‰è¾¹è·ï¼ˆgithub.com, ~10sï¼‰
  - âœ… URL å‚æ•°éªŒè¯
  - âœ… æµè§ˆå™¨æ± è·¨æœåŠ¡å¤ç”¨éªŒè¯

#### 11. Content Extraction API â­ NEW
- âœ… `src/services/content.service.ts` - å†…å®¹æŠ“å–æœåŠ¡
  - HTML å®Œæ•´å†…å®¹æå–
  - çº¯æ–‡æœ¬å†…å®¹æå–
  - æ™ºèƒ½å…ƒæ•°æ®æå–
    - Open Graph åè®®æ”¯æŒ
    - Twitter Cards æ”¯æŒ
    - æ ‡å‡† meta æ ‡ç­¾è§£æ
  - çµæ´»çš„å†…å®¹é€‰é¡¹æ§åˆ¶
  - æµè§ˆå™¨æ± å¤ç”¨ä¼˜åŒ–
- âœ… `src/api/rest/content.route.ts` - Content API è·¯ç”±
  - Zod å‚æ•°éªŒè¯
  - å®Œå–„çš„é”™è¯¯å¤„ç†
  - ç»“æ„åŒ–æ—¥å¿—è®°å½•
- âœ… **æµ‹è¯•éªŒè¯**
  - âœ… åŸºç¡€å†…å®¹æŠ“å–ï¼ˆexample.comï¼‰
  - âœ… å¯Œå…ƒæ•°æ®æå–ï¼ˆgithub.comï¼‰
    - title: "GitHub Â· Build and ship software on a single, collaborative platform"
    - description: å®Œæ•´æè¿°æ–‡æœ¬
    - image: Open Graph å›¾ç‰‡ URL
  - âœ… é€‰æ‹©æ€§å†…å®¹æå–ï¼ˆä»…å…ƒæ•°æ®ï¼‰
  - âœ… URL å‚æ•°éªŒè¯
  - âœ… æµè§ˆå™¨æ± è·¨æœåŠ¡å¤ç”¨éªŒè¯

#### 12. Scrape API (æ•°æ®æŠ“å–) â­ NEW
- âœ… `src/services/scrape.service.ts` - æ•°æ®æŠ“å–æœåŠ¡
  - CSS é€‰æ‹©å™¨æ”¯æŒ
  - å¤šç§å±æ€§æå– (textContent, innerText, innerHTML, value, href, src)
  - è‡ªå®šä¹‰ HTML å±æ€§æå–
  - å•ä¸ª/å¤šä¸ªå…ƒç´ æŠ“å–
  - waitForSelector æ”¯æŒ
  - å»¶è¿ŸåŠ è½½æ”¯æŒ
  - æµè§ˆå™¨æ± å¤ç”¨ä¼˜åŒ–
- âœ… `src/api/rest/scrape.route.ts` - Scrape API è·¯ç”±
  - Zod å‚æ•°éªŒè¯
  - å®Œå–„çš„é”™è¯¯å¤„ç†
  - ç»“æ„åŒ–æ—¥å¿—è®°å½•
- âœ… **æµ‹è¯•éªŒè¯**
  - âœ… åŸºç¡€æ•°æ®æŠ“å–ï¼ˆexample.com - h1, p, aï¼‰
  - âœ… å¤šå…ƒç´ æŠ“å–ï¼ˆmultiple: trueï¼‰
  - âœ… å±æ€§æå–ï¼ˆhref attributeï¼‰
  - âœ… å¤æ‚é€‰æ‹©å™¨ï¼ˆGitHub - meta[property="og:description"]ï¼‰
  - âœ… URL å‚æ•°éªŒè¯
  - âœ… æµè§ˆå™¨æ± è·¨æœåŠ¡å¤ç”¨éªŒè¯ï¼ˆtotalUseCount: 3ï¼‰

#### 13. Prometheus ç›‘æ§ â­ NEW
- âœ… `src/utils/metrics.ts` - Prometheus æŒ‡æ ‡å®šä¹‰
  - é»˜è®¤ç³»ç»ŸæŒ‡æ ‡æ”¶é›†ï¼ˆCPU, å†…å­˜, äº‹ä»¶å¾ªç¯å»¶è¿Ÿï¼‰
  - HTTP è¯·æ±‚è®¡æ•°å’ŒæŒç»­æ—¶é—´ç›´æ–¹å›¾
  - æµè§ˆå™¨æ± çŠ¶æ€ Gauge
  - ä»»åŠ¡æ‰§è¡ŒæŒ‡æ ‡ï¼ˆæŒç»­æ—¶é—´å’Œè®¡æ•°ï¼‰
  - æ´»è·ƒä¼šè¯å’Œé˜Ÿåˆ—é•¿åº¦ Gauge
- âœ… `/metrics` ç«¯ç‚¹
  - Prometheus æ ¼å¼å¯¼å‡º
  - è‡ªåŠ¨æ›´æ–°æµè§ˆå™¨æ± æŒ‡æ ‡
  - é€šè¿‡ä¸­é—´ä»¶è‡ªåŠ¨è®°å½•æ‰€æœ‰ HTTP è¯·æ±‚
- âœ… **æµ‹è¯•éªŒè¯**
  - âœ… é»˜è®¤æŒ‡æ ‡æ”¶é›†ï¼ˆè¿›ç¨‹ CPU, å†…å­˜, äº‹ä»¶å¾ªç¯ï¼‰
  - âœ… HTTP è¯·æ±‚æŒ‡æ ‡è‡ªåŠ¨è®°å½•
  - âœ… æµè§ˆå™¨æ± çŠ¶æ€è‡ªåŠ¨æ›´æ–°
  - âœ… Prometheus æ ¼å¼æ­£ç¡®å¯¼å‡º

#### 14. WebSocket Proxy Server (CDP ä»£ç†) â­ NEW
- âœ… `src/services/websocket-proxy.service.ts` - WebSocket ä»£ç†æœåŠ¡ï¼ˆå·²åºŸå¼ƒï¼‰
  - åˆå§‹å®ç°é‡åˆ° Fastify WebSocket å…¼å®¹æ€§é—®é¢˜
- âœ… `src/api/websocket/proxy.route.ts` - WebSocket ä»£ç†è·¯ç”±ï¼ˆç®€åŒ–ç‰ˆï¼‰
  - ç›´æ¥åœ¨è·¯ç”±å±‚å®ç°æ¶ˆæ¯è½¬å‘
  - ä»æµè§ˆå™¨æ± è·å–æµè§ˆå™¨å®ä¾‹
  - å®¢æˆ·ç«¯ WebSocket â†”ï¸ æµè§ˆå™¨ WebSocket åŒå‘ä»£ç†
  - è¿æ¥ç”Ÿå‘½å‘¨æœŸç®¡ç†
  - é”™è¯¯å¤„ç†å’Œèµ„æºæ¸…ç†
- âœ… `/ws` ç«¯ç‚¹
  - æ”¯æŒ Puppeteer/Playwright é€šè¿‡ WebSocket è¿æ¥
  - CDP åè®®é€ä¼ 
  - æµè§ˆå™¨æ± é›†æˆ
- âš ï¸  **çŠ¶æ€ï¼šåŸºç¡€å®ç°å®Œæˆï¼Œå¾…è°ƒè¯•**
  - âœ… WebSocket è¿æ¥å»ºç«‹æˆåŠŸ
  - âœ… æµè§ˆå™¨å®ä¾‹è·å–å’Œ WebSocket ç«¯ç‚¹è¿æ¥
  - â³ æ¶ˆæ¯è½¬å‘æœºåˆ¶éœ€è¦è¿›ä¸€æ­¥è°ƒè¯•
  - â³ éœ€è¦å®Œæ•´çš„ç«¯åˆ°ç«¯æµ‹è¯•éªŒè¯

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```javascript
// Puppeteer è¿æ¥ç¤ºä¾‹
const puppeteer = require('puppeteer-core');

const browser = await puppeteer.connect({
  browserWSEndpoint: 'ws://localhost:3001/ws'
});

const page = await browser.newPage();
await page.goto('https://example.com');
await browser.close();
```

**æŠ€æœ¯è¯´æ˜ï¼š**
- ä½¿ç”¨ @fastify/websocket æ’ä»¶
- ç›´æ¥ä»£ç† CDP (Chrome DevTools Protocol) æ¶ˆæ¯
- æ¯ä¸ª WebSocket è¿æ¥è·å–ç‹¬ç«‹çš„æµè§ˆå™¨å®ä¾‹
- è¿æ¥å…³é—­æ—¶è‡ªåŠ¨é‡Šæ”¾æµè§ˆå™¨åˆ°æ± ä¸­

#### 15. Session Manager (ä¼šè¯ç®¡ç†å™¨) â­ NEW
- âœ… `src/core/session/SessionManager.ts` - ä¼šè¯ç®¡ç†æ ¸å¿ƒå®ç°
  - EventEmitter äº‹ä»¶ç³»ç»Ÿ
  - ä¼šè¯ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆåˆ›å»ºã€è·å–ã€å…³é—­ï¼‰
  - è‡ªåŠ¨è¶…æ—¶æ¸…ç†ï¼ˆæ¯30ç§’æ£€æŸ¥ï¼‰
  - ç©ºé—²ä¼šè¯æ£€æµ‹å’Œæ¸…ç†
  - æœ€å¤§å­˜æ´»æ—¶é—´æ§åˆ¶
  - ä¼šè¯ç»Ÿè®¡å’Œç›‘æ§
- âœ… `src/api/rest/session.route.ts` - Session API è·¯ç”±
  - `GET /sessions` - è·å–æ‰€æœ‰æ´»è·ƒä¼šè¯
  - `GET /sessions/:id` - è·å–æŒ‡å®šä¼šè¯è¯¦æƒ…
  - `DELETE /sessions/:id` - å…³é—­æŒ‡å®šä¼šè¯
  - `GET /sessions/stats` - è·å–ä¼šè¯ç»Ÿè®¡
- âœ… **é›†æˆå’ŒåŠŸèƒ½**
  - âœ… WebSocket Proxy é›†æˆ SessionManager
  - âœ… è‡ªåŠ¨æ´»åŠ¨æ—¶é—´æ›´æ–°
  - âœ… è¿æ¥å…³é—­æ—¶è‡ªåŠ¨æ¸…ç†ä¼šè¯
  - âœ… å¥åº·æ£€æŸ¥ç«¯ç‚¹åŒ…å«ä¼šè¯ç»Ÿè®¡
  - âœ… Prometheus æŒ‡æ ‡é›†æˆ
- âœ… **ç›‘æ§æŒ‡æ ‡**
  - âœ… `browser_autos_sessions` - ä¼šè¯çŠ¶æ€ Gaugeï¼ˆactive, idleï¼‰
  - âœ… `browser_autos_session_duration_seconds` - ä¼šè¯æŒç»­æ—¶é—´ Histogram
  - âœ… `browser_autos_session_total` - ä¼šè¯åˆ›å»ºæ€»æ•° Counter
- âœ… **æµ‹è¯•éªŒè¯**
  - âœ… ä¼šè¯ç»Ÿè®¡ API æ­£å¸¸å·¥ä½œ
  - âœ… ä¼šè¯åˆ—è¡¨ API è¿”å›æ­£ç¡®æ ¼å¼
  - âœ… å¥åº·æ£€æŸ¥åŒ…å«ä¼šè¯ä¿¡æ¯
  - âœ… Prometheus metrics åŒ…å«ä¼šè¯æŒ‡æ ‡

**åŠŸèƒ½ç‰¹ç‚¹ï¼š**
- è‡ªåŠ¨è¶…æ—¶ç®¡ç†ï¼šç©ºé—²5åˆ†é’Ÿè‡ªåŠ¨å…³é—­
- æœ€å¤§å­˜æ´»æ—¶é—´ï¼šä¼šè¯æœ€é•¿å­˜æ´»1å°æ—¶
- äº‹ä»¶ç³»ç»Ÿï¼šæ”¯æŒä¼šè¯åˆ›å»ºã€å…³é—­ã€è¶…æ—¶ç­‰äº‹ä»¶
- å®Œæ•´ç›‘æ§ï¼šæä¾›è¯¦ç»†çš„ä¼šè¯ç»Ÿè®¡å’Œ Prometheus æŒ‡æ ‡
- ä¼˜é›…æ¸…ç†ï¼šæ”¯æŒå•ä¸ªä¼šè¯å…³é—­å’Œæ‰¹é‡å…³é—­

#### 16. è®¤è¯ç³»ç»Ÿå®Œå–„å’Œå®‰å…¨åŠ å›º ğŸ”’ NEW (2025-10-11)
- âœ… **API è®¤è¯ä¿æŠ¤** - ä¿®å¤ä¸¥é‡å®‰å…¨æ¼æ´
  - é—®é¢˜ï¼šæ‰€æœ‰ API å®Œå…¨å…¬å¼€ï¼Œæ— ä»»ä½•è®¤è¯ä¿æŠ¤
  - è§£å†³ï¼šä¸ºæ‰€æœ‰ä¸šåŠ¡ API æ·»åŠ è®¤è¯ä¸­é—´ä»¶
    - `/screenshot` - Screenshot API
    - `/pdf` - PDF Generation API
    - `/content` - Content Extraction API
    - `/scrape` - Web Scraping API
    - `/sessions/*` - Session Management API
  - æ”¯æŒ JWT Token å’Œ API Key ä¸¤ç§è®¤è¯æ–¹å¼
  - å¯é€šè¿‡ `REQUIRE_AUTH` ç¯å¢ƒå˜é‡æ§åˆ¶ï¼ˆç”Ÿäº§é»˜è®¤ `true`ï¼‰

- âœ… **è®¤è¯ä¸­é—´ä»¶å®ç°**
  - `src/middleware/auth.middleware.ts`
    - `auth()` - ç»„åˆè®¤è¯ï¼ˆJWT æˆ– API Keyï¼‰
    - `jwtAuth()` - JWT Token è®¤è¯
    - `apiKeyAuth()` - API Key è®¤è¯
    - `requireRole()` - è§’è‰²éªŒè¯
    - `requirePermission()` - æƒé™éªŒè¯
    - `optionalAuth()` - å¯é€‰è®¤è¯

- âœ… **é…ç½®æ›´æ–°**
  - `src/config/index.ts` - æ·»åŠ  `requireAuth` é…ç½®é¡¹
  - `.env.example` - æ·»åŠ  `REQUIRE_AUTH` å’Œ `ENABLE_QUEUE` é…ç½®

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```bash
# 1. JWT Token è®¤è¯
TOKEN=$(curl -s -X POST http://localhost:3001/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username": "admin", "password": "admin123"}' \
  | jq -r '.data.accessToken')

curl -X POST http://localhost:3001/screenshot \
  -H "Authorization: Bearer $TOKEN" \
  -d '{"url": "https://example.com"}'

# 2. API Key è®¤è¯
curl -X POST http://localhost:3001/screenshot \
  -H "X-API-Key: <api_key>" \
  -d '{"url": "https://example.com"}'

# 3. å¼€å‘ç¯å¢ƒç¦ç”¨è®¤è¯ï¼ˆå¯é€‰ï¼‰
# .env
REQUIRE_AUTH=false
```

**å®‰å…¨æå‡ï¼š**
- âŒ ä¹‹å‰ï¼šæ‰€æœ‰ API å®Œå…¨å…¬å¼€ï¼Œæ— ä»»ä½•è®¤è¯
- âœ… ç°åœ¨ï¼šæ‰€æœ‰ä¸šåŠ¡ API éƒ½éœ€è¦ JWT æˆ– API Key è®¤è¯
- âœ… æ”¯æŒçµæ´»çš„è®¤è¯æ§åˆ¶ï¼ˆç”Ÿäº§å¼ºåˆ¶ï¼Œå¼€å‘å¯é€‰ï¼‰

#### 17. Docker å¤šæ¶æ„æ”¯æŒ ğŸš€ NEW (2025-10-11)
- âœ… **å¤šæ¶æ„é•œåƒæ„å»º**
  - æ”¯æŒ `linux/amd64` (Intel/AMD 64ä½)
  - æ”¯æŒ `linux/arm64` (Apple Silicon, AWS Graviton)
  - ä½¿ç”¨ Docker buildx æ„å»ºå¤šæ¶æ„é•œåƒ

- âœ… **Docker Hub å‘å¸ƒ**
  - ä»“åº“ï¼š`browserautos/chromium:latest`
  - åŸºç¡€é•œåƒï¼šDebian Bookworm Slim
  - æµè§ˆå™¨ï¼šPlaywright Chromium 141.0.7390.37
  - é•œåƒå¤§å°ï¼š~1.4GB (æ¯ä¸ªæ¶æ„)

- âœ… **æœ¬åœ°æµ‹è¯•éªŒè¯**
  - arm64 é•œåƒæµ‹è¯•é€šè¿‡
  - å¥åº·æ£€æŸ¥æ­£å¸¸
  - è®¤è¯åŠŸèƒ½æ­£å¸¸
  - æˆªå›¾ API æ­£å¸¸ (PNG 20KB)

**ä½¿ç”¨æ–¹å¼ï¼š**
```bash
# æ‹‰å–é•œåƒï¼ˆè‡ªåŠ¨é€‰æ‹©åŒ¹é…çš„æ¶æ„ï¼‰
docker pull browserautos/chromium:latest

# è¿è¡Œå®¹å™¨
docker run -d --name chromium -p 3001:3001 \
  -e JWT_SECRET=your-secret-key \
  --shm-size=2gb --memory=4g \
  browserautos/chromium:latest

# ç¦ç”¨è®¤è¯ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
docker run -d --name chromium -p 3001:3001 \
  -e JWT_SECRET=your-secret-key \
  -e REQUIRE_AUTH=false \
  --shm-size=2gb --memory=4g \
  browserautos/chromium:latest
```

**å…¼å®¹æ€§æå‡ï¼š**
- âŒ ä¹‹å‰ï¼šä»…æ”¯æŒ amd64 æ¶æ„
- âœ… ç°åœ¨ï¼šæ”¯æŒ amd64 + arm64 åŒæ¶æ„
- âœ… é€‚ç”¨äº Apple Silicon, AWS Graviton, Azure ARM ç­‰å¹³å°

**æ–‡æ¡£ï¼š**
- `backend/SECURITY_AND_MULTIARCH_UPDATE.md` - è¯¦ç»†æ›´æ–°æ–‡æ¡£

### ğŸ“Š MVP åŠŸèƒ½æ¼”ç¤º

```bash
# è¿è¡ŒæœåŠ¡å™¨ï¼ˆç«¯å£ 3001ï¼‰
cd backend && npm run dev

# æµ‹è¯•å¥åº·æ£€æŸ¥ï¼ˆåŒ…å«æµè§ˆå™¨æ± çŠ¶æ€ï¼‰
curl http://localhost:3001/health | jq .

# ç”Ÿæˆæˆªå›¾
curl -X POST http://localhost:3001/screenshot \
  -H "Content-Type: application/json" \
  -d '{"url": "https://example.com", "format": "png"}' \
  -o screenshot.png

# æŸ¥çœ‹æµè§ˆå™¨æ± ç»Ÿè®¡
curl http://localhost:3001/health | jq '.data.browserPool'

# ç”Ÿæˆ PDF
curl -X POST http://localhost:3001/pdf \
  -H "Content-Type: application/json" \
  -d '{"url": "https://example.com", "format": "A4"}' \
  -o document.pdf

# æŠ“å–ç½‘é¡µå†…å®¹ï¼ˆHTML + æ–‡æœ¬ + å…ƒæ•°æ®ï¼‰
curl -X POST http://localhost:3001/content \
  -H "Content-Type: application/json" \
  -d '{"url": "https://github.com"}' | jq .

# ä»…æå–å…ƒæ•°æ®
curl -X POST http://localhost:3001/content \
  -H "Content-Type: application/json" \
  -d '{"url": "https://github.com", "includeHtml": false, "includeText": false}' \
  | jq '.data.metadata'

# æŠ“å–ç»“æ„åŒ–æ•°æ®ï¼ˆå•ä¸ªå…ƒç´ ï¼‰
curl -X POST http://localhost:3001/scrape \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://example.com",
    "elements": [
      {"selector": "h1", "property": "textContent"},
      {"selector": "a", "property": "href"}
    ]
  }' | jq '.data.data'

# æŠ“å–å¤šä¸ªå…ƒç´ 
curl -X POST http://localhost:3001/scrape \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://example.com",
    "elements": [
      {"selector": "p", "property": "textContent", "multiple": true}
    ]
  }' | jq '.data.data'

# æŸ¥çœ‹ä¼šè¯ç»Ÿè®¡
curl http://localhost:3001/sessions/stats | jq

# æŸ¥çœ‹æ´»è·ƒä¼šè¯åˆ—è¡¨
curl http://localhost:3001/sessions | jq

# å…³é—­æŒ‡å®šä¼šè¯
curl -X DELETE http://localhost:3001/sessions/{session-id} | jq
```

### ğŸš€ æ€§èƒ½åŸºå‡†æµ‹è¯•

**æµ‹è¯•ç¯å¢ƒï¼š** macOS, Chrome, æœ¬åœ°å¼€å‘

| åœºæ™¯ | æ— æµè§ˆå™¨æ±  | ä½¿ç”¨æµè§ˆå™¨æ±  | æå‡ |
|------|-----------|------------|------|
| é¦–æ¬¡æˆªå›¾ | 7.6s | 2.6s | 65% â†‘ |
| è¿ç»­æˆªå›¾ | 4.8s | 1.2s | 85% â†‘ |
| å¹³å‡å“åº” | ~6s | ~1.5s | 75% â†‘ |

### ğŸ“‹ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **æµè§ˆå™¨æ± ç®¡ç†** (Browser Pool)
   - å®ç°æµè§ˆå™¨å®ä¾‹çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†
   - è¿æ¥æ± æœºåˆ¶ï¼ˆè·å–ã€é‡Šæ”¾ã€å¤ç”¨ï¼‰
   - èµ„æºç›‘æ§å’Œè‡ªåŠ¨æ¸…ç†

2. **Session ç®¡ç†å™¨** (Session Manager)
   - WebSocket ä¼šè¯ç®¡ç†
   - ä¼šè¯è¶…æ—¶å’Œæ¸…ç†
   - å¤šç§Ÿæˆ·éš”ç¦»

3. **é˜Ÿåˆ—ç®¡ç†å™¨** (Queue Manager)
   - Bull é˜Ÿåˆ—é›†æˆ
   - ä»»åŠ¡è°ƒåº¦å’Œæ‰§è¡Œ
   - é‡è¯•å’Œé”™è¯¯å¤„ç†

4. **REST API ç«¯ç‚¹**
   - `/screenshot` - æˆªå›¾æœåŠ¡
   - `/pdf` - PDF ç”Ÿæˆ
   - `/content` - å†…å®¹æŠ“å–
   - `/scrape` - æ•°æ®æŠ“å–

5. **WebSocket ä»£ç†**
   - CDP åè®®ä»£ç†
   - Puppeteer/Playwright è¿æ¥æ”¯æŒ

6. **ç›‘æ§å’ŒæŒ‡æ ‡**
   - Prometheus metrics
   - å¥åº·æ£€æŸ¥å®Œå–„

7. **Docker éƒ¨ç½²**
   - Dockerfile ç¼–å†™
   - docker-compose é…ç½®
   - Redis é›†æˆ

8. **æµ‹è¯•å’Œæ–‡æ¡£**
   - å•å…ƒæµ‹è¯•
   - é›†æˆæµ‹è¯•
   - API æ–‡æ¡£

---

*æœ€åæ›´æ–°: 2025-10-11*
