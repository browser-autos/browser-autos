# è‡ªåŠ¨æ£€æŸ¥ Alpine Chromium ç‰ˆæœ¬æ›´æ–°
# æ¯å‘¨æ£€æŸ¥ä¸€æ¬¡ Alpine ä»“åº“ä¸­çš„ Chromium ç‰ˆæœ¬

name: Chromium Version Check

on:
  schedule:
    # æ¯å‘¨ä¸€ UTC 01:00 (åŒ—äº¬æ—¶é—´ 09:00) è¿è¡Œ
    - cron: '0 1 * * 1'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  check-chromium-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Check Alpine Chromium version
        id: check-version
        run: |
          echo "Checking Alpine 3.22 Chromium version..."

          # èŽ·å– Alpine ä»“åº“ä¸­çš„ Chromium ç‰ˆæœ¬
          ALPINE_VERSION=$(docker run --rm alpine:3.22 sh -c "apk info chromium | grep 'chromium-' | head -1 | cut -d'-' -f2")
          echo "Alpine Chromium version: $ALPINE_VERSION"
          echo "alpine_version=$ALPINE_VERSION" >> $GITHUB_OUTPUT

          # èŽ·å–å½“å‰ Dockerfile ä¸­è®°å½•çš„ç‰ˆæœ¬ï¼ˆå¦‚æžœæœ‰ï¼‰
          if grep -q "CHROMIUM_VERSION" backend/Dockerfile; then
            CURRENT_VERSION=$(grep "CHROMIUM_VERSION" backend/Dockerfile | cut -d'=' -f2 | tr -d '"')
            echo "Current documented version: $CURRENT_VERSION"
            echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          else
            echo "No version documented in Dockerfile"
            echo "current_version=unknown" >> $GITHUB_OUTPUT
          fi

      - name: Check Playwright Chromium version
        id: check-playwright
        run: |
          echo "Checking Playwright Chromium version..."

          # èŽ·å– Playwright åŒ…çš„æœ€æ–°ç‰ˆæœ¬
          PLAYWRIGHT_VERSION=$(npm view playwright version)
          echo "Playwright latest version: $PLAYWRIGHT_VERSION"
          echo "playwright_version=$PLAYWRIGHT_VERSION" >> $GITHUB_OUTPUT

          # èŽ·å– package.json ä¸­çš„ Playwright ç‰ˆæœ¬
          CURRENT_PLAYWRIGHT=$(cat backend/package.json | grep '"playwright"' | cut -d'"' -f4 | tr -d '^~')
          echo "Current Playwright version: $CURRENT_PLAYWRIGHT"
          echo "current_playwright=$CURRENT_PLAYWRIGHT" >> $GITHUB_OUTPUT

      - name: Create issue if update available
        if: steps.check-version.outputs.alpine_version != steps.check-version.outputs.current_version || steps.check-playwright.outputs.playwright_version != steps.check-playwright.outputs.current_playwright
        uses: actions/github-script@v8
        with:
          script: |
            const alpineVersion = '${{ steps.check-version.outputs.alpine_version }}';
            const currentVersion = '${{ steps.check-version.outputs.current_version }}';
            const playwrightVersion = '${{ steps.check-playwright.outputs.playwright_version }}';
            const currentPlaywright = '${{ steps.check-playwright.outputs.current_playwright }}';

            let body = '## ðŸ”„ Browser Version Update Available\n\n';

            if (alpineVersion !== currentVersion) {
              body += `### Alpine Chromium Update\n\n`;
              body += `- **Current**: ${currentVersion}\n`;
              body += `- **Available**: ${alpineVersion}\n\n`;
              body += `Update the \`CHROMIUM_VERSION\` in \`backend/Dockerfile\` to document the new version.\n\n`;
            }

            if (playwrightVersion !== currentPlaywright) {
              body += `### Playwright Update\n\n`;
              body += `- **Current**: ${currentPlaywright}\n`;
              body += `- **Available**: ${playwrightVersion}\n\n`;
              body += `Dependabot will create a PR for this update automatically.\n\n`;
            }

            body += `### Actions\n\n`;
            body += `- [ ] Review Chromium release notes\n`;
            body += `- [ ] Update Dockerfile if needed\n`;
            body += `- [ ] Test Docker image build\n`;
            body += `- [ ] Update documentation\n\n`;
            body += `---\n*This issue was automatically created by the Chromium Version Check workflow.*`;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'chromium-update'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸ”„ Browser Version Update: Chromium ${alpineVersion} / Playwright ${playwrightVersion}`,
                body: body,
                labels: ['chromium-update', 'dependencies']
              });
            }
